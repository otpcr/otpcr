#!/usr/bin/env python3
# This file is placed in the Public Domain.


import os
import queue
import shutil
import sys
import threading
import time


sys.path.insert(0, os.getcwd())


from otpcr.clients import Client
from otpcr.command import Commands
from otpcr.message import Message
from otpcr.objects import Config, Methods
from otpcr.package import Mods
from otpcr.persist import Workdir
from otpcr.threads import Thread
from otpcr.utility import Time, Utils


from otpcr import modules as MODS


try:
    import mods as MODS2
except ModuleNotFoundError:
    MODS2 = None


events = queue.Queue()


"config"

Cfg = Config()
Cfg.debug = True
Cfg.ignore = ""
Cfg.level = "info"
Cfg.name = Mods.pkgname(Commands)
Cfg.txt = " ".join(sys.argv[1:])
Cfg.version = 100
Cfg.wdr = ".test"


"clients"


class CLI(Client):

    def __init__(self):
        Client.__init__(self)
        self.register("command", Commands.command)

    def raw(self, txt):
        if "v" in Cfg.opts:
            print(txt)


class ClientPool:

    clients = []
    lock = threading.RLock()
    nrcpu = 1
    nrlast = 0

    @staticmethod
    def add(client):
        ClientPool.clients.append(client)

    @staticmethod
    def init(nrcpu, cls):
        ClientPool.nrcpu = nrcpu
        for _x in range(ClientPool.nrcpu):
            clt = cls()
            clt.start()
            ClientPool.add(clt)

    @staticmethod
    def put(*args):
        with ClientPool.lock:
            if ClientPool.nrlast >= ClientPool.nrcpu-1:
                ClientPool.nrlast = 0
            clt = ClientPool.clients[ClientPool.nrlast]
            clt.put(*args)
            ClientPool.nrlast += 1



"utilities"


def banner():
    tme = time.ctime(time.time()).replace("  ", " ")
    print(f"{Cfg.name.upper()} {Cfg.version} since {tme} ({Cfg.level})")
    sys.stdout.flush()


def check(text):
    args = sys.argv[1:]
    for arg in args:
        if not arg.startswith("-"):
            continue
        for char in text:
            if char in arg:
                return True
    return False


def consume():
    while True:
        try:
            event = events.get()
            event.wait()
            events.task_done()
        except (KeyboardInterrupt, EOFError):
            os._exit(0)


def payload(todo):
    for cmd, example in todo.items():
        for ex in example:
            evt = Message()
            evt.text = f"{cmd} {ex}"
            evt.kind = "command"
            ClientPool.put(evt)
            events.put(evt)


"runtime"


def wrap(func):
    "restore console."
    import termios
    old = None
    try:
        old = termios.tcgetattr(sys.stdin.fileno())
    except termios.error:
        pass
    try:
        Utils.wrapped(func)
    finally:
        pass
    if old:
        termios.tcsetattr(sys.stdin.fileno(), termios.TCSADRAIN, old)


def main():
    if "p" not in Cfg.opts and os.path.exists(Cfg.wdr):
        shutil.rmtree(Cfg.wdr)
    Methods.parse(Cfg, " ".join(sys.argv[1:]))
    Workdir.setwd(Cfg.wdr)
    Mods.init("modules", MODS.__path__[0])
    if MODS2:
        Mods.init("mods", MODS2.__path__[0])
    Mods.scanner(Mods.list())
    if "v" in Cfg.opts:
        banner()
    if "z" in Cfg.opts:
        ClientPool.init(os.cpu_count(), CLI)
    else:
        ClientPool.init(1, CLI)
    starttime = time.time()
    nrs = Cfg.index or 1
    for _x in range(nrs):
        payload(pre)
    for _x in range(nrs):
        payload(examples)
    for _x in range(nrs):
        payload(post)
    Thread.launch(consume)
    nrevents = events.qsize()
    try:
        events.join()
    except (KeyboardInterrupt, EOFError):
        pass
    endtime = time.time()
    lap = Time.elapsed(endtime-starttime)
    percall = (endtime-starttime)/nrevents
    nrs = events.qsize()
    if "v" in Cfg.opts:
        print(f"{Methods.fmt(Cfg, skip='otxt,txt')}")
        print(f"{nrs} events left.")
        print(f"total: {lap} nrs: {nrevents} call: %.6fs" % percall)


"date"


examples = {
    "atr": [""],
    "cmd": [""],
    "dis": [""],
    "dne": ["", "bla"],
    "dpl": ["hnrss title,url", ""],
    "eml": ["", "root@localhost"],
    "flt": ["", "0"],
    "fnd": ["", "log", "rss", "config", "todo"],
    "lou": [""],
    "man": ["", "test"],
    "mbx": [""],
    "mod": [""],
    "mre": [""],
    "nme": ["", "hnrss hackernews"],
    "now": [""],
    "pth": [""],
    "pwd": ["", "bla mekker"],
    "req": [""],
    "res": ["", "hnrss"],
    "sil": [""],
    "slg": [""],
    "srv": [""],
    "syn": [""],
    "thr": [""],
    "tmr": ["", "22:00 test"],
    "upt": [""],
    "wsd": [""]
}

pre = {
    "cfg": ["", "nick=mekker"],
    "imp": ["",
         "testing/feeds.opml",
    ],
    "log": ["", "log add"],
    "rss": ["", "http://hnrss.org/newest"],
    "tdo": ["", "test"]
}

post = {
    "dbg": [""],
    "dne": ["", "mekker"],
    "exp": [""],
    "rem": ["", "hnrss"]
}


"trampoline"


if __name__ == "__main__":
    wrap(main)
